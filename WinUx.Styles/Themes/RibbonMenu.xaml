<UserControl x:Class="WinUx.Controls.RibbonMenu"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:ctrls="clr-namespace:WinUx.Controls"
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             mc:Ignorable="d"
             d:DesignHeight="40" d:DesignWidth="200">
    <UserControl.Resources>
        <!-- Ribbon toggle style (minimal, used for PART_Toggle) -->
        <Style x:Key="RibbonToggleButtonStyle" TargetType="ToggleButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="MinWidth" Value="88"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="0"
                                CornerRadius="2"
                                SnapsToDevicePixels="True">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="18"/>
                                </Grid.ColumnDefinitions>

                                <ContentPresenter Grid.Column="0"
                                                  VerticalAlignment="Center"
                                                  HorizontalAlignment="Left"
                                                  Margin="2,0,4,0"/>

                                <!-- Chevron -->
                                <Path Grid.Column="1" Data="M 0 0 L 6 6 L 12 0"
                                      HorizontalAlignment="Center"
                                      VerticalAlignment="Center"
                                      Stretch="Uniform"
                                      Stroke="#444"
                                      StrokeThickness="1.2"
                                      SnapsToDevicePixels="True"/>
                            </Grid>
                        </Border>

                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#F3F6F8"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#E8EEF2"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#EEF6FF"/>
                                <Setter TargetName="Bd" Property="BorderBrush" Value="#D7EFFE"/>
                                <Setter TargetName="Bd" Property="BorderThickness" Value="1"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.6"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Tab header style (Fluent-like) -->
        <Style x:Key="RibbonTabHeaderText" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Margin" Value="8,6"/>
        </Style>

        <!-- Group container (Fluent group visual) -->
        <Style x:Key="RibbonGroupBorder" TargetType="Border">
            <Setter Property="Background" Value="#FFF"/>
            <Setter Property="BorderBrush" Value="#E6E9EE"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="8"/>
            <Setter Property="CornerRadius" Value="2"/>
            <Setter Property="Margin" Value="4,0,4,0"/>
        </Style>

        <!-- Large square button (icon over label) for Button -->
        <Style x:Key="RibbonLargeButton" TargetType="Button">
            <Setter Property="Width" Value="72"/>
            <Setter Property="Padding" Value="6"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="0"
                                CornerRadius="2">
                            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Margin="2">
                                <ContentPresenter x:Name="IconPresenter" Content="{TemplateBinding Content}" 
                                                  HorizontalAlignment="Center" VerticalAlignment="Center" />
                                <TextBlock Text="{TemplateBinding Tag}" 
                                           TextWrapping="Wrap" 
                                           FontSize="11" 
                                           Foreground="#222" 
                                           HorizontalAlignment="Center" 
                                           Margin="0,6,0,0"/>
                            </StackPanel>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="IconPresenter" Property="Opacity" Value="0.85"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Small inline button (icon + label) for Button -->
        <Style x:Key="RibbonSmallButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="Padding" Value="6,4"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="0"
                                CornerRadius="2">
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <ContentPresenter Content="{TemplateBinding Content}" Margin="0,0,8,0" VerticalAlignment="Center"/>
                                <TextBlock Text="{TemplateBinding Tag}" VerticalAlignment="Center" Foreground="#222" FontSize="12"/>
                            </StackPanel>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Large/Small ToggleButton styles (duplicate of button styles but for ToggleButton target type) -->
        <Style x:Key="RibbonLargeToggleButton" TargetType="ToggleButton">
            <Setter Property="Width" Value="72"/>
            <Setter Property="Padding" Value="6"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="0"
                                CornerRadius="2">
                            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Margin="2">
                                <ContentPresenter x:Name="IconPresenter" Content="{TemplateBinding Content}" 
                                                  HorizontalAlignment="Center" VerticalAlignment="Center" />
                                <TextBlock Text="{TemplateBinding Tag}" 
                                           TextWrapping="Wrap" 
                                           FontSize="11" 
                                           Foreground="#222" 
                                           HorizontalAlignment="Center" 
                                           Margin="0,6,0,0"/>
                            </StackPanel>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="RibbonSmallToggleButton" TargetType="ToggleButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="Padding" Value="6,4"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="0"
                                CornerRadius="2">
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <ContentPresenter Content="{TemplateBinding Content}" Margin="0,0,8,0" VerticalAlignment="Center"/>
                                <TextBlock Text="{TemplateBinding Tag}" VerticalAlignment="Center" Foreground="#222" FontSize="12"/>
                            </StackPanel>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- DataTemplates for model types -->

        <!-- RibbonButtonItem: supports Large/Small via per-button Style triggers -->
        <DataTemplate DataType="{x:Type ctrls:RibbonButtonItem}">
            <Grid>
                <!-- Large visual -->
                <Button Command="{Binding Command}"
                        CommandParameter="{Binding CommandParameter}"
                        Tag="{Binding Label}">
                    <Button.Style>
                        <Style TargetType="Button" BasedOn="{StaticResource RibbonLargeButton}">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Size}" Value="{x:Static ctrls:RibbonButtonSize.Large}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                    <ContentPresenter Content="{Binding Icon}" Width="36" Height="36"/>
                </Button>

                <!-- Small visual -->
                <Button Command="{Binding Command}"
                        CommandParameter="{Binding CommandParameter}"
                        Tag="{Binding Label}">
                    <Button.Style>
                        <Style TargetType="Button" BasedOn="{StaticResource RibbonSmallButton}">
                            <Setter Property="Visibility" Value="Visible"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Size}" Value="{x:Static ctrls:RibbonButtonSize.Large}">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                    <ContentPresenter Content="{Binding Icon}" Width="16" Height="16"/>
                </Button>
            </Grid>
        </DataTemplate>

        <!-- RibbonToggleItem: same handling as button but toggleable, use ToggleButton-specific styles -->
        <DataTemplate DataType="{x:Type ctrls:RibbonToggleItem}">
            <Grid>
                <ToggleButton IsChecked="{Binding IsChecked, Mode=TwoWay}"
                              Command="{Binding Command}"
                              CommandParameter="{Binding CommandParameter}"
                              Tag="{Binding Label}">
                    <ToggleButton.Style>
                        <Style TargetType="ToggleButton" BasedOn="{StaticResource RibbonLargeToggleButton}">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Size}" Value="{x:Static ctrls:RibbonButtonSize.Large}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ToggleButton.Style>
                    <ContentPresenter Content="{Binding Icon}" Width="36" Height="36"/>
                </ToggleButton>

                <ToggleButton IsChecked="{Binding IsChecked, Mode=TwoWay}"
                              Command="{Binding Command}"
                              CommandParameter="{Binding CommandParameter}"
                              Tag="{Binding Label}">
                    <ToggleButton.Style>
                        <Style TargetType="ToggleButton" BasedOn="{StaticResource RibbonSmallToggleButton}">
                            <Setter Property="Visibility" Value="Visible"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Size}" Value="{x:Static ctrls:RibbonButtonSize.Large}">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ToggleButton.Style>
                    <ContentPresenter Content="{Binding Icon}" Width="16" Height="16"/>
                </ToggleButton>
            </Grid>
        </DataTemplate>

        <DataTemplate DataType="{x:Type ctrls:RibbonSeparatorItem}">
            <Separator VerticalAlignment="Stretch" Margin="8,0"/>
        </DataTemplate>

        <DataTemplate DataType="{x:Type ctrls:RibbonCustomItem}">
            <ContentPresenter Content="{Binding Content}"/>
        </DataTemplate>

        <!-- String fallback -->
        <DataTemplate DataType="{x:Type sys:String}">
            <Button Command="{Binding DataContext.ItemCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                    CommandParameter="{Binding}"
                    Style="{StaticResource RibbonSmallButton}"
                    Tag="{Binding}">
            </Button>
        </DataTemplate>
    </UserControl.Resources>

    <Grid>
        <!-- Toggle button that opens the popup -->
        <ToggleButton x:Name="PART_Toggle"
                      Style="{StaticResource RibbonToggleButtonStyle}"
                      Content="{Binding Title, RelativeSource={RelativeSource AncestorType=UserControl}}"
                      VerticalAlignment="Center"/>

        <!-- Popup showing ribbon-like UI stretched to window width -->
        <Popup x:Name="PART_Popup"
               PlacementTarget="{Binding ElementName=PART_Toggle}"
               Placement="Bottom"
               StaysOpen="False"
               AllowsTransparency="True"
               PopupAnimation="Slide">
            <Border Background="White" BorderBrush="#DDD" BorderThickness="1" CornerRadius="0" Padding="0" SnapsToDevicePixels="True">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Tab strip -->
                    <ItemsControl Grid.Row="0"
                                  ItemsSource="{Binding TabsSource, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                  Background="Transparent"
                                  Margin="6,6,6,6">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="Transparent" Padding="6">
                                    <TextBlock Text="{Binding Header}" Style="{StaticResource RibbonTabHeaderText}"/>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Tab content -->
                    <ScrollViewer Grid.Row="1" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled" MaxHeight="320">
                        <ItemsControl ItemsSource="{Binding TabsSource, RelativeSource={RelativeSource AncestorType=UserControl}}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Vertical"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>

                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <ItemsControl ItemsSource="{Binding Groups}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <StackPanel Orientation="Horizontal" Margin="6"/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>

                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Style="{StaticResource RibbonGroupBorder}">
                                                    <StackPanel>
                                                        <TextBlock Text="{Binding Header}" FontSize="12" FontWeight="SemiBold" Margin="0,0,0,6"/>
                                                        <ItemsControl ItemsSource="{Binding Items}">
                                                            <ItemsControl.ItemsPanel>
                                                                <ItemsPanelTemplate>
                                                                    <WrapPanel Orientation="Horizontal" ItemWidth="80" ItemHeight="Auto"/>
                                                                </ItemsPanelTemplate>
                                                            </ItemsControl.ItemsPanel>

                                                            <ItemsControl.ItemContainerStyle>
                                                                <Style TargetType="ContentPresenter">
                                                                    <Setter Property="Margin" Value="4"/>
                                                                </Style>
                                                            </ItemsControl.ItemContainerStyle>
                                                        </ItemsControl>
                                                    </StackPanel>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>
        </Popup>
    </Grid>
</UserControl>